let dataTable;
let currentPage = 1;
let tableDataContainer;
let cacheMap = new Map();

export function putTableInfoFromCache(id) {
    const cachedData = cacheMap.get(id);
    if (cachedData) {
        if (Array.isArray(cachedData) && cachedData.length > 0) {
            tableDataContainer.push(...cachedData);
            dataTable.clear().rows.add(cachedData.map(Object.values)).draw();
        } else {
            console.warn("Empty or invalid cached data.");
        }
    } else {
        putTableInfoFromServer(id);
    }
}


function putTableInfoFromServer(id) {
    const fetchData = (pageNumber) => {
        const faturaData = {
            vatnumber: id,
            page: pageNumber,
        };

        fetch("/tableinfo", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(faturaData),
        })
            .then((response) => response.json())
            .then((data) => {
                checkDataTable(data);

                if (pageNumber < data.last_page) {
                    fetchData(pageNumber + 1);
                } else {
                    cacheMap.set(id, tableDataContainer);
                }
            })
            .catch((error) => {
                checkDataTable("");
            });
    };

    fetchData(1);
}

function checkDataTable(data) {
    console.log("nish")
    if (!dataTable) {
        dataTable = $("#example").DataTable();
        // addStyle();
        tableDataContainer = [];
    }
    if (data && data.data && data.data.length > 0) {
        tableDataContainer.push(...data.data);
        dataTable.rows.add(data.data.map(Object.values));
        currentPage = data.current_page + 1;
        setTimeout(() => {
            dataTable.draw();
        }, 10);
    } else {
        dataTable.clear().draw();
        tableDataContainer = [];
        currentPage = 1;
    }
}


















// //This function is use to style the table
// function addStyle() {
//     var tableNumbers = document.querySelector(".col-md-7");
//     var tableNumbers1 = document.querySelector(".col-md-5");
//     var showEntries = document.querySelector(".col-md-6");
//     var tablee = document.querySelector("table.dataTable");

//     var search = document.getElementById("example_filter");
//     if (tableNumbers) {
//         tableNumbers.style.position = "fixed";
//         tableNumbers.style.marginLeft = "18%";
//         tableNumbers.style.bottom = "10px";
//         tableNumbers.style.right = "10px";
//     } else {
//         console.error("Element with class 'col-md-7' not found.");
//     }
//     if (tableNumbers1) {
//         tableNumbers1.style.position = "fixed";
//         tableNumbers1.style.bottom = "10px";
//     } else {
//         console.error("Element with class 'col-md-5' not found.");
//     }
//     if (search) {
//         search.style.position = "fixed";
//         search.style.right = "-9px";
//         search.style.setProperty("margin-top", "-13px", "important");
//         search.style.zIndex = "1000000";
//         search.style.backgroundColor = "white";
//         search.style.height = "40.5px";
//     } else {
//         console.error("Element with id 'example_filter' not found.");
//     }
//     if (showEntries) {
//         showEntries.style.position = "fixed";
//         showEntries.style.setProperty("margin-top", "-13px", "important");
//         showEntries.style.zIndex = "1000000";
//         showEntries.style.backgroundColor = "white";
//         showEntries.style.height = "40px";
//         showEntries.style.width = "100%"

//     } else {
//         console.error("Element with class 'col-md-6' not found.");
//     }
//     if (tablee) {
//         tablee.style.setProperty("margin-top", "35px", "important");
//         tablee.style.height = "100%";
//     } else {
//         console.error("Element with class 'col-md-6' not found.");
//     }
// }
// //....................................................................

// //This function contain all info of the table
// export function getTableDataContainer() {
//     return tableDataContainer;
// }

// //This function take info of data call a function that filter and then put the filtered
// //   info in the table
// function logDates() {
//     var first = document.getElementById("date-checkin").value;
//     var second = document.getElementById("date-checkout").value;
//     var dataToFilter = getTableDataContainer();
//     var afterFilter = filterDataWithDate(dataToFilter, first, second);
//     dataTable.clear();
//     dataTable.rows.add(afterFilter.map(Object.values));
//     dataTable.draw();
// }

// //This function is used to call the filter method when the button is clecked
// var filter_button = document.getElementById("filter_button");
// filter_button.addEventListener("click", (e) => {
//     e.preventDefault();
//     logDates();
// });

// //It fielter the data and then it return to put them in the table
// function filterDataWithDate(dataToFilter, startDate, endDate) {
//     const start = new Date(startDate);
//     const end = new Date(endDate);
//     const filteredData = dataToFilter.filter(item => {
//         const createdAtDate = new Date(item.createdat);
//         return createdAtDate >= start && createdAtDate <= end;
//     });
//     return filteredData;
// }

// function cache(){
//     var temporary = document.querySelector("prova");

// }
